<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>...</title> <!-- Default page title which can be overridden by query params. The title shows inside the tab button while redirecting. -->
    <link rel="icon" href="" type="image/x-icon"> <!-- Attempt to delete github favicon and use default browser icon instead. Untested. -->
    <style>
        /* Light mode styling */
        html {
            margin: 0;
            padding: 0;
            padding-left: 0.75rem;
            font-family: system-ui, -apple-system, sans-serif;
            background-color: color-mix(in srgb, white, black 0%);
            color: black
        }

        /* Dark mode styling */
        @media (prefers-color-scheme: dark) {
            html {
                background-color: color-mix(in srgb, black, white 10%);;
                color: white
            }
        }
    </style>
    
    <script>

        // Constants
        const sourceLocale = "en";
        
        // Function to get URL parameters
        function getQueryParam(param) {
            var searchParams = new URLSearchParams(window.location.search);
            return searchParams.get(param);
        }

        // Redirect to the URL specified in the 'url' query parameter
        function openURLAndCloseTab(url, postaction) {
            
            // This is copied from mac-mouse-fix-website/public/activate/index.html and then modified.
            //  Basically, we open the url, and if the redirect website is still open after the redirect (which happens if the url links into a non-browswer app such as Mail or Mac Mouse Fix), then we try to automatically close the window or navigate back in the browser history.
            // Notes:
            // - We decided against displaying "Redirecting..." in the window while redirecting. It's English so not language agnostic. I thought the blank page might be confusing to users, but it only shows up for a second.
            // - Autoclosing doesn't work when we're using the redirect-service from GitHub Markdown. 
            //  - I think it only works if the window hosting the redirect-service was opened by js or something? (That's what the messages in Safari console suggest.)
            // 
            // Notes on postactions:
            // - We only execute the postaction if the link is opened outside of the browser. E.g. a mailto: link.
            // - close postaction: The 10ms delay before installing onfocus is necessary for Firefox to not close immediately
            // - back postaction: When building back postaction, the 10ms delay didn't seem to be necessary for Firefox. Maybe Firefox fixed things? Idk. but the 10ms delay doesn't hurt so leaving it.
            // - any postaction:
            //    - We want the redirect window to close/goback immediately after opening the URL. But not before opening the url. 
            //    - We achieve something somewhat close to that with the window.onfocus() callbacks. 
            //        - In Chrome, those callbacks don't trigger immediately after opening the app, instead they only open after you click the window which displays the redirect page after the app has been opened. 
            //        - In Safari, we see the same behaviour as Chrome if the user has clicked 'Always Allow' in the 'Allow <website> to open <app>?' dialog. However, if the user manually clicks 'Allow' in that dialog, the window.onfocus() callback will trigger immediately after the url is openend, which is the ideal behaviour we want.
            //            - To reset the 'Always Allow' choice in Safari, you need to manually edit ~/Library/Safari/PerSitePreferences.db. See: https://apple.stackexchange.com/questions/465335/how-to-retract-always-allow-safari-permission-for-opening-app
            //        - We used to autoclose the redirection window after 5s to make it a bit better, but that also closes the window while the 'Allow <website> to open <app>?' dialog is still open, which would be annoying if the user is still trying to read the dialog.

            // Validate
            if (url == undefined) {
                document.getElementById("message").innerText += `Target url is undefined`;
                return;
            }
            if (url.includes(window.location.hostname) && (false)) { 
                // Note: 
                //     Turning this validation off since it triggers when redirecting to feedback-assistant (as of 30.08.2024)
                //     Why did I ever think this is a problem?
                document.getElementById("message").innerText += `Target url ${url} contains current hostname`;
                return;
            }

            // Redirect
            window.location.href = url;

            // Post-action
            if (postaction == "close") {
                setTimeout(function () { window.onfocus = function () { window.close(); }; }, 10);     // Install onfocus listener after 10ms
                // setTimeout(function () { window.close(); }, 5 * 1000);                                 // Close after 5s
            } else if (postaction == "back") {
                setTimeout(function () { window.onfocus = function () { window.history.back(); }; }, 10);    // Install onfocus listener after 10ms
                // window.onfocus = function () { window.history.back(); };
            }
        }

        function redirect() {

            // Parse params
            var target = getQueryParam("target");
            var customPageTitle = getQueryParam("page-title");
            var customMessage = getQueryParam("message");
            var locale = getQueryParam("locale");
            if (!target) {
                document.getElementById("message").innerText += "No redirection target provided!";
                return
            }
            if (customMessage) {
                document.getElementById("message").innerText += decodeURIComponent(customMessage);
            }
            if (customPageTitle) {
                document.title = customPageTitle; // Not sure this works, I haven't tested.
            }
            
            // Map target to url
            var urlMap = {
                /// `macmousefix:` links
                "mmfl-activate": "macmousefix:activate",
                /// Non-browser:
                "macos-settings-loginitems": "x-apple.systempreferences:com.apple.LoginItems-Settings.extension",
                "mailto-noah": "",
                /// MMF:
                "mmf-github-readme": "https://github.com/noah-nuebling/mac-mouse-fix/",
                "mmf-acknowledgements": "https://github.com/noah-nuebling/mac-mouse-fix/blob/master/Acknowledgements.md",
                "mmf-about": "https://github.com/noah-nuebling/mac-mouse-fix",
                "mmf-questions": "https://github.com/noah-nuebling/mac-mouse-fix?tab=readme-ov-file#questions",
                "mmf2-latest": "https://github.com/noah-nuebling/mac-mouse-fix/releases/tag/2.2.4",
                /// MMF Feedback:
                "mmf-feedback-bug-report": "https://noah-nuebling.github.io/mac-mouse-fix-feedback-assistant/?type=bug-report",
                "mmf-feedback-feature-request": "https://noah-nuebling.github.io/mac-mouse-fix-feedback-assistant/?type=feature-request",
                "mmf-feedback-other": "https://noah-nuebling.github.io/mac-mouse-fix-feedback-assistant/?type=other",
                /// MMF Guides:
                "mmf-localization-guide": "https://github.com/noah-nuebling/mac-mouse-fix/discussions/731", 
                "mmf-ventura-enabling-guide": "https://github.com/noah-nuebling/mac-mouse-fix/discussions/861", 
                "mmf-guides": "https://github.com/noah-nuebling/mac-mouse-fix/discussions/categories/guides",
                "mmf-compatibility-guide": "https://github.com/noah-nuebling/mac-mouse-fix?tab=readme-ov-file#macos-compatibility",
                "mmf-captured-buttons-guide": "https://github.com/noah-nuebling/mac-mouse-fix/discussions/112",
            };

            // Override map 
            //    for specific locale
            if (locale != null && locale != sourceLocale) {

                // MMF:
                urlMap["mmf-github-readme"] = `https://github.com/noah-nuebling/mac-mouse-fix/blob/master/Markdown/LocalizedDocuments/${locale}/Readme.md`;
                urlMap["mmf-acknowledgements"] = `https://github.com/noah-nuebling/mac-mouse-fix/blob/master/Markdown/LocalizedDocuments/${locale}/Acknowledgements.md`;
                urlMap["mmf-about"] = `https://github.com/noah-nuebling/mac-mouse-fix/blob/master/Markdown/LocalizedDocuments/${locale}/Readme.md`;
                urlMap["mmf-questions"] = `https://github.com/noah-nuebling/mac-mouse-fix/blob/master/Markdown/LocalizedDocuments/${locale}/Readme.md#questions`;
                urlMap["mmf2-latest"] = `https://github.com/noah-nuebling/mac-mouse-fix/releases/tag/2.2.4`; // TODO: Update if/when we localize

                // MMF Feedback:
                //    Note: We don't need to localize this since feedback-assistant supports js and can set localization itself based on browser settings.
                
                // MMF Guides:
                urlMap["mmf-guides"] = `https://github.com/noah-nuebling/mac-mouse-fix/discussions/categories/guides`; // TODO: Update if/when we localize
                urlMap["mmf-compatibility-guide"] = `https://github.com/noah-nuebling/mac-mouse-fix/blob/master/Markdown/LocalizedDocuments/${locale}/Readme.md#macos-compatibility`; // Note: The #macos-compatibility fragment works in any language, because we added non-localized anchor links to the .md files (such as `<a name="macos-compatibility"></a>`)
                urlMap["mmf-captured-buttons-guide"] = `https://github.com/noah-nuebling/mac-mouse-fix/discussions/112`; // TODO: Update once we localize this.
            }
            
            var url;
            if (Object.hasOwn(urlMap, target)) {

                if (target == "mailto-noah") {
                    // Handle email separately from urlMap to prevent automatic crawling of the address, and to allow custom param for prefilling email subject.
                    const subject = encodeURIComponent(getQueryParam("subject") ?? "");
                    const body = encodeURIComponent(getQueryParam("body") ?? "");
                    const e1 = "com"; const e2 = "gmail"; const e3 = "public"; const e4 = ".n"; const e5 = "noah";
                    url = `mailto:${e5}${e4}.${e3}@${e2}.${e1}?subject=${subject}&body=${body}`;
                } else {
                    url = urlMap[target];
                }
            } else {
                document.getElementById("message").innerText += `Unknown redirection target "${target}". Known targets:\n${Object.keys(urlMap)}`;
                return;
            }

            // Decide what to do after redirect

            var postaction = null
            
            const urlScheme = url.split(':')[0]
            const urlOpensInBrowser = (urlScheme == 'http' || urlScheme == 'https')
            const urlIsInvalid = (urlScheme == '' || urlScheme == null)
            
            if (urlIsInvalid) {
                document.getElementById("message").innerText += `Unknown url scheme "${urlScheme}". url: ${url}`;
                return;
            }
            if (urlOpensInBrowser) {
                postaction = "nothing";
            } else {
                postaction = window.history.length > 1 ? "back" : "close";
            }

            // Open url
            openURLAndCloseTab(url, postaction);
        }
    </script>
</head>

<body onload="redirect()">
    <p id="message"></p>
</body>
</html>
